#+TITLE: Monitoring Data Entry for Haryana Surveys
#+AUTHOR: SSER
#+OPTIONS: H:3 ^:{}
#+LATEX_HEADER: \usepackage{booktabs}
#+LATEX_HEADER: \usepackage{tabularx}
#+TODO: TODO EDIT CHECK | DONE
#+PROPERTY: header-args:R :session haryana :eval never-export

* Preliminaries                                                    :noexport:

#+NAME: load-libraries
#+BEGIN_SRC R :results silent :exports none
  require(RPostgreSQL)
  require(ggplot2)
  require(data.table)
#+END_SRC

#+NAME: open-database-connection
#+BEGIN_SRC R :results silent :exports none
source("sserconnect.R")
#+END_SRC

#+NAME: read-data-code
#+BEGIN_SRC R :results silent :exports none
  dbListTables(surveypg)->t

  data.table(dbReadTable(surveypg,"ruralsurvey_household"))->household

  data.table(dbReadTable(surveypg,"ruralsurvey_member"))->member
  data.table(dbReadTable(surveypg,"ruralsurvey_codecaste"))->castes
  data.table(dbReadTable(surveypg,"ruralsurvey_codevillage"))->villages
  data.table(dbReadTable(surveypg,"ruralsurvey_coderelationship"))->relationship


  data.table(dbReadTable(surveypg,"ruralsurvey_codeoccupationcategory"))->occupationcode

  data.table(dbReadTable(surveypg,"ruralsurvey_occupations_household_members"))->occupations
  data.table(dbReadTable(surveypg,"ruralsurvey_current_ownership_holdings"))->ownershipholding
  data.table(dbReadTable(surveypg,"ruralsurvey_irrigation_ownership_holdings"))->irrigation
  #dbDisconnect(surveypg)

#+END_SRC

#+BEGIN_SRC R :results value :exports none
  dbListTables(surveypg)->t
#+END_SRC

#+RESULTS:

* Overall Decisions

This section records any overall decisions that are taken.

**** TODO Decide on how to deal with ranges
**** TODO Fix social group for each caste
+ Each caste belongs to a unique social group. This needs to be correctly identified and informed to all data operators.
**** TODO Sample weights
+ Vikas needs to check the sampling scripts and get the sampling weights.
**** DONE Standard values of assets                                :Vikas:
CLOSED: [2018-11-11 Sun 05:56]
***** Compute unit price from available data, and provide a table of summary statistics for each type of asset

* Database corrections                                                :Vikas:
***** TODO FIES filter on names
***** TODO Comments on FIES questions
***** TODO Crops filter
***** DONE CodePlaces
***** DONE Make a block/page-wise table of data operators
CLOSED: [2018-11-11 Sun 06:59]

***** Type of contract in labouring out should be foreign key

** Corrections in design of land tables                           :noexport:

#+NAME: separate-irrigation
#+BEGIN_SRC R 
  drv <- dbDriver("PostgreSQL")

    surveypg <- dbConnect(drv, dbname = "ssersurveydata",
                     host = "localhost", port = 5432,)

    dbListTables(surveypg)

    ave(ownershipholding$id,ownershipholding$sno_id,FUN=rank)->ownershipholding$parcel_number
    names(ownershipholding)
    ownershipholding[,c(1,16,9:12,15,14)]->irrigation
  irrigation[is.na(irrigation_src_type)&is.na(comments),irrigation_src_type:="Unirrigated"]

  sql_truncate <- paste("TRUNCATE ", "ruralsurvey_irrigation_ownership_holdings")
  res <- dbSendQuery(conn=surveypg, statement=sql_truncate)
  dbWriteTable(surveypg,"ruralsurvey_irrigation_ownership_holdings",irrigation,row.names=FALSE,append=TRUE)
    dbReadTable(surveypg,"ruralsurvey_irrigation_ownership_holdings")
    dbDisconnect(surveypg)
#+END_SRC

#+NAME: combine-leases
#+BEGIN_SRC R
  drv <- dbDriver("PostgreSQL")

  surveypg <- dbConnect(drv, dbname = "ssersurveydata",
                     host = "localhost", port = 5432,)

  dbListTables(surveypg)

  as.data.table(dbReadTable(surveypg,"ruralsurvey_land_leased_in_fixed_rent"))->leasecontracts
  leasecontracts$transfer_in_out<-"In"
  leasecontracts$contract_type<-"Fixed rent"

  as.data.table(dbReadTable(surveypg,"ruralsurvey_land_leased_out_fixed_rent"))->leaseoutfixed
  leaseoutfixed$transfer_in_out<-"Out"
  leaseoutfixed$contract_type<-"Fixed rent"

  names(leasecontracts)[c(1:6)]->names(leaseoutfixed)[c(1:6)]
  names(leaseoutfixed)[names(leaseoutfixed)=="loans_from_owner"]<-"loans_from_to_partner"
  names(leaseoutfixed)[names(leaseoutfixed)=="tenant_caste_id"]<-"partner_caste_id"
  names(leaseoutfixed)[names(leaseoutfixed)=="tenant_occupation_id"]<-"partner_occupation_id"
  names(leaseoutfixed)[names(leaseoutfixed)=="kind_unit_id"]<-"crop_qty_unit_id"
  names(leaseoutfixed)[names(leaseoutfixed)=="kind"]<-"crop_qty"
  paste("SYO: ",leaseoutfixed$syo,"; ",leaseoutfixed$comments,sep="")->leaseoutfixed$comments
  leaseoutfixed[,syo:=NULL]

  rbindlist(list(leasecontracts,leaseoutfixed), use.names=TRUE, fill=TRUE, idcol=TRUE)->a
  a[,.id:=NULL]
  #ownershipholding[,c(1,16,9:12,15,14)]->irrigation
  #irrigation[is.na(irrigation_src_type)&is.na(comments),irrigation_src_type:="Unirrigated"]



  ave(a$id,a$sno_id,FUN=rank)->a$parcel_number

  a[,c(41,2,3,39,40,4,5,7,19,17,16,18)]->a1

  sql_truncate <- paste("TRUNCATE ", "ruralsurvey_land_tenancy_mortgage") ##unconditional DELETE FROM…
  res <- dbSendQuery(conn=surveypg, statement=sql_truncate)
  dbWriteTable(surveypg,"ruralsurvey_land_tenancy_mortgage",a1,row.names=FALSE,append=TRUE)

  a->a2
  a2[,transfer_in_out:=NULL]
  a2[,contract_type:=NULL]
  a2[,id:=NULL]
  sql_truncate <- paste("TRUNCATE ", "ruralsurvey_land_leased_in_fixed_rent") ##unconditional DELETE FROM…
  res <- dbSendQuery(conn=surveypg, statement=sql_truncate)
  dbWriteTable(surveypg,"ruralsurvey_land_leased_in_fixed_rent",a2,row.names=FALSE,append=TRUE)




  dbDisconnect(surveypg)
#+END_SRC
* Inconsistencies in Data                                       :Sonia:Jesim:
** TODO Households for which data are missing for critical variables

This section lists data gaps that are critical. Sonia to attend to these, in consultation with Jesim, where required.

#+NAME: missing-data-code
#+BEGIN_SRC R :results value :exports results :colnames yes :hline yes
  merge(household,villages,by.x="village_id",by.y="id")->t
  merge(member,t,by.x="sno_id",by.y="id")->t
  merge(t,relationship,by.x="relationship_id",by.y="id")->t
  t[is.na(marital_status),.(village_name,household_number,age.x,blankfield="marital_status",detail=relationship)][order(village_name,household_number)]
#+END_SRC

#+NAME: missing-data-code
#+CAPTION: Households with data missing for critical variables
#+RESULTS: missing-data-code
| village_name     | household_number | age.x | blankfield     | detail          |
|------------------+------------------+-------+----------------+-----------------|
| Birdhana         |               63 |    31 | marital_status | Son             |
| Birdhana         |               71 |    24 | marital_status | Son             |
| Birdhana         |               71 |    23 | marital_status | Son             |
| Birdhana         |              101 |    27 | marital_status | Son             |
| Cheher Kalan     |               10 |    76 | marital_status | Self            |
| Cheher Kalan     |               10 |    19 | marital_status | Granddaughter   |
| Cheher Kalan     |               10 |    15 | marital_status | Granddaughter   |
| Cheher Kalan     |               10 |    15 | marital_status | Granddaughter   |
| Cheher Kalan     |               10 |    13 | marital_status | Granddaughter   |
| Cheher Kalan     |               10 |    17 | marital_status | Grandson        |
| Cheher Kalan     |               10 |    42 | marital_status | Daughter-in-law |
| Cheher Kalan     |               11 |     4 | marital_status | Son             |
| Cheher Kalan     |               15 |  0.25 | marital_status | Granddaughter   |
| Cheher Kalan     |               19 |    19 | marital_status | Son             |
| Cheher Kalan     |               24 |    40 | marital_status | Son             |
| Cheher Kalan     |               24 |    20 | marital_status | Grandson        |
| Cheher Kalan     |               24 |    23 | marital_status | Grandson        |
| Cheher Kalan     |               24 |     9 | marital_status | Grandson        |
| Cheher Kalan     |               24 |    30 | marital_status | Daughter-in-law |
| Cheher Kalan     |               24 |    37 | marital_status | Daughter-in-law |
| Cheher Kalan     |               26 |     0 | marital_status | Granddaughter   |
| Cheher Kalan     |               27 |    23 | marital_status | Son             |
| Cheher Kalan     |               27 |    14 | marital_status | Son             |
| Cheher Kalan     |               28 |     7 | marital_status | Son             |
| Cheher Kalan     |               28 |     6 | marital_status | Son             |
| Cheher Kalan     |               29 |    11 | marital_status | Son             |
| Cheher Kalan     |               29 |     4 | marital_status | Daughter        |
| Cheher Kalan     |               37 |    16 | marital_status | Granddaughter   |
| Cheher Kalan     |               37 |     2 | marital_status | Granddaughter   |
| Cheher Kalan     |               41 |   5.6 | marital_status | Granddaughter   |
| Cheher Kalan     |               41 |   2.1 | marital_status | Grandson        |
| Cheher Kalan     |               42 |    17 | marital_status | Son             |
| Cheher Kalan     |               42 |    20 | marital_status | Daughter        |
| Cheher Kalan     |               42 |    15 | marital_status | Daughter        |
| Cheher Kalan     |               43 |     1 | marital_status | Granddaughter   |
| Cheher Kalan     |               43 |     9 | marital_status | Grandson        |
| Cheher Kalan     |               43 |     8 | marital_status | Grandson        |
| Cheher Kalan     |               43 |     3 | marital_status | Grandson        |
| Cheher Kalan     |               43 |     3 | marital_status | Grandson        |
| Cheher Kalan     |               45 |    10 | marital_status | Granddaughter   |
| Cheher Kalan     |               45 |     8 | marital_status | Grandson        |
| Cheher Kalan     |               46 |     6 | marital_status | Granddaughter   |
| Cheher Kalan     |               46 |     3 | marital_status | Granddaughter   |
| Cheher Kalan     |               46 |     4 | marital_status | Grandson        |
| Cheher Kalan     |               46 |    13 | marital_status | Grandson        |
| Cheher Kalan     |               46 |    25 | marital_status | Daughter-in-law |
| Cheher Kalan     |               47 |    12 | marital_status | Son             |
| Cheher Kalan     |               47 |    10 | marital_status | Son             |
| Cheher Kalan     |               47 |    15 | marital_status | Daughter        |
| Cheher Kalan     |               49 |    50 | marital_status | Brother         |
| Cheher Kalan     |               50 |    20 | marital_status | Granddaughter   |
| Cheher Kalan     |               50 |     2 | marital_status | Granddaughter   |
| Cheher Kalan     |               50 |     5 | marital_status | Grandson        |
| Cheher Kalan     |               51 |    50 | marital_status | Son             |
| Cheher Kalan     |               51 |    17 | marital_status | Granddaughter   |
| Cheher Kalan     |               51 |    23 | marital_status | Grandson        |
| Cheher Kalan     |               51 |    14 | marital_status | Grandson        |
| Cheher Kalan     |               51 |    40 | marital_status | Daughter-in-law |
| Cheher Kalan     |               52 |   0.3 | marital_status | Grandson        |
| Cheher Kalan     |               53 |    16 | marital_status | Daughter        |
| Cheher Kalan     |               53 |    11 | marital_status | Daughter        |
| Jamalpur Shekhan |                3 |    13 | marital_status | Grandson        |
| Jamalpur Shekhan |                3 |     9 | marital_status | Grandson        |
| Jamalpur Shekhan |                6 |     4 | marital_status | Daughter        |
| Jamalpur Shekhan |                8 |    14 | marital_status | Grandson        |
| Jamalpur Shekhan |                8 |    12 | marital_status | Grandson        |
| Jamalpur Shekhan |               10 |   0.4 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               12 |    18 | marital_status | Son             |
| Jamalpur Shekhan |               12 |    16 | marital_status | Son             |
| Jamalpur Shekhan |               14 |     6 | marital_status | Daughter        |
| Jamalpur Shekhan |               29 |     3 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               29 |   1.5 | marital_status | Grandson        |
| Jamalpur Shekhan |               31 |    34 | marital_status | Son             |
| Jamalpur Shekhan |               31 |   2.2 | marital_status | Grandson        |
| Jamalpur Shekhan |               34 |     6 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               34 |     2 | marital_status | Grandson        |
| Jamalpur Shekhan |               37 |   nil | marital_status | Mother          |
| Jamalpur Shekhan |               38 |    55 | marital_status | Self            |
| Jamalpur Shekhan |               38 |    18 | marital_status | Son             |
| Jamalpur Shekhan |               41 |     5 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               41 |     3 | marital_status | Grandson        |
| Jamalpur Shekhan |               43 |    90 | marital_status | Self            |
| Jamalpur Shekhan |               50 |    35 | marital_status | Son             |
| Jamalpur Shekhan |               51 |   nil | marital_status | Grandson        |
| Jamalpur Shekhan |               51 |   nil | marital_status | Grandson        |
| Jamalpur Shekhan |               51 |   nil | marital_status | Grandson        |
| Jamalpur Shekhan |               51 |   nil | marital_status | Grandson        |
| Jamalpur Shekhan |               54 |    33 | marital_status | Son             |
| Jamalpur Shekhan |               54 |   2.5 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               54 |    28 | marital_status | Grandson        |
| Jamalpur Shekhan |               54 |   nil | marital_status | Grandson        |
| Jamalpur Shekhan |               54 |   1.5 | marital_status | Grandson        |
| Jamalpur Shekhan |               55 |     6 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               55 |    10 | marital_status | Grandson        |
| Jamalpur Shekhan |               55 |     8 | marital_status | Grandson        |
| Jamalpur Shekhan |               56 |   4.6 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               56 |    10 | marital_status | Grandson        |
| Jamalpur Shekhan |               59 |    11 | marital_status | Son             |
| Jamalpur Shekhan |               67 |     8 | marital_status | Granddaughter   |
| Jamalpur Shekhan |               67 |     6 | marital_status | Grandson        |
| Jamalpur Shekhan |               67 |     4 | marital_status | Grandson        |
| Jamalpur Shekhan |               73 |    80 | marital_status | Mother          |

** Data categorisation issues
**** TODO Majhabi Sikh and Rai Sikh are perhaps same
**** TODO Jhimar and Dhinvar are same
**** TODO Lohar categorised as both BC and SC

** Abnormal asset prices

#+NAME: asset_outlier_code
#+BEGIN_SRC R :results value :exports results :colnames yes :hline yes

  dbReadTable(surveypg,"ruralsurvey_asset_ownership_other")->t0
  dbReadTable(surveypg,"ruralsurvey_code_asset_others")->code
  merge(t0,code,by.x="asset_id",by.y="id")->t0

  dbReadTable(surveypg,"ruralsurvey_asset_ownership_transport")->t1
  dbReadTable(surveypg,"ruralsurvey_code_asset_transport")->code
  merge(t1,code,by.x="asset_id",by.y="id")->t1

  dbReadTable(surveypg,"ruralsurvey_asset_ownership_electrical")->t2
  dbReadTable(surveypg,"ruralsurvey_code_asset_electrical")->code
  merge(t2,code,by.x="asset_id",by.y="id")->t2

  dbReadTable(surveypg,"ruralsurvey_asset_ownership_furniture")->t3
  dbReadTable(surveypg,"ruralsurvey_code_asset_furniture")->code
  merge(t3,code,by.x="asset_id",by.y="id")->t3


  dbReadTable(surveypg,"ruralsurvey_asset_ownership_inventories")->t4
  dbReadTable(surveypg,"ruralsurvey_code_asset_inventories")->code
  merge(t4,code,by.x="asset_id",by.y="id")->t4

  data.table(rbind(t0,t1,t2,t3))->t
  merge(household,villages,by.x="village_id",by.y="id")->h
  merge(t,h,by.x="sno_id",by.y="id")->t
  t$value/t$no->t$price
  t[!is.na(price)]->t
  t[asset=="Scooter/motorcycle"][price>100000][,.(village_name,household_number,asset,price)]->t1
  rbind(t1,t[asset=="Refrigerator"][price>10000][,.(village_name,household_number,asset,price)])->t1
  rbind(t1,t[asset=="Almirah/cupboard"][price>10000][,.(village_name,household_number,asset,price)])->t1
  rbind(t1,t[asset=="Tape recorder/Two-in-one"][price>5000][,.(village_name,household_number,asset,price)])->t1
  t1
#+END_SRC

#+name: asset_outlier
#+CAPTION: Abnormal values of asset prices
#+RESULTS: asset_outlier_code
| village_name     | household_number | asset              |  price |
|------------------+------------------+--------------------+--------|
| Cheher Kalan     |               50 | Scooter/motorcycle | 125000 |
| Cheher Kalan     |               22 | Refrigerator       |  20000 |
| Khandrai         |                1 | Refrigerator       |  25000 |
| Jamalpur Shekhan |               67 | Refrigerator       |  14000 |
| Jamalpur Shekhan |                9 | Almirah/cupboard   |  35000 |

**** Match homestead land with housing information. Check if value of house and land are recorded.

* Number of Rows in Database Tables

#+NAME: tablerows-code 
#+BEGIN_SRC sql :engine postgresql :dbhost localhost :dbuser ssersurveyuser :database ssersurveydata :colnames yes
SELECT relname,n_live_tup
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;
#+END_SRC

#+NAME: tablerows
#+CAPTION: Number of rows in each database table
#+RESULTS: tablerows-code
| relname                                                         | n_live_tup |
|-----------------------------------------------------------------+------------|
| django_admin_log                                                |       5571 |
| ruralsurvey_occupations_household_members                       |       2538 |
| ruralsurvey_asset_ownership_electrical                          |       2095 |
| ruralsurvey_member                                              |       1747 |
| ruralsurvey_housing_materials                                   |       1590 |
| ruralsurvey_asset_ownership_furniture                           |       1048 |
| ruralsurvey_asset_ownership_inventories                         |        998 |
| ruralsurvey_asset_ownership_other                               |        873 |
| auth_group_permissions                                          |        579 |
| ruralsurvey_source_of_water_for_domestic_use                    |        457 |
| ruralsurvey_asset_ownership_land_buildings                      |        444 |
| auth_permission                                                 |        387 |
| ruralsurvey_asset_ownership_transport                           |        340 |
| auth_user_user_permissions                                      |        321 |
| ruralsurvey_housing                                             |        313 |
| ruralsurvey_household                                           |        307 |
| ruralsurvey_current_ownership_holdings                          |        145 |
| ruralsurvey_irrigation_ownership_holdings                       |        145 |
| django_content_type                                             |        129 |
| ruralsurvey_cropping_pattern_schedule_production_and_sales      |        120 |
| ruralsurvey_codeeducationalinstitution                          |        100 |
| ruralsurvey_housing_q                                           |         80 |
| ruralsurvey_codeplaces                                          |         76 |
| ruralsurvey_crop_sales                                          |         74 |
| ruralsurvey_codeplaceofbirth                                    |         73 |
| ruralsurvey_land_tenancy_mortgage                               |         64 |
| ruralsurvey_land_leased_in_fixed_rent                           |         64 |
| ruralsurvey_codeoccupationcategory                              |         62 |
| ruralsurvey_housing_assistance                                  |         51 |
| django_migrations                                               |         42 |
| ruralsurvey_scholarships_pensions_rents_remittances             |         42 |
| ruralsurvey_codecaste                                           |         41 |
| ruralsurvey_codevariety                                         |         35 |
| ruralsurvey_business_and_artisan_earnings_household_members     |         33 |
| ruralsurvey_land_leased_out_fixed_rent                          |         31 |
| ruralsurvey_non_agricultural_manual_labouring_out               |         27 |
| ruralsurvey_code_asset_electrical                               |         24 |
| ruralsurvey_code_materials                                      |         24 |
| ruralsurvey_purchases_from_the_public_distribution_system       |         23 |
| ruralsurvey_business_and_artisan_earnings                       |         22 |
| ruralsurvey_code_asset_inventories                              |         22 |
| ruralsurvey_coderelationship                                    |         21 |
| ruralsurvey_income_from_salaries                                |         21 |
| ruralsurvey_codeitem                                            |         21 |
| django_session                                                  |         19 |
| ruralsurvey_code_source_of_borrowing                            |         16 |
| ruralsurvey_codeinputtype                                       |         15 |
| ruralsurvey_assets                                              |         14 |
| ruralsurvey_animal_resources_milk                               |         13 |
| ruralsurvey_code_purpose_of_borrowing                           |         13 |
| auth_user                                                       |         13 |
| ruralsurvey_codecrop                                            |         11 |
| ruralsurvey_code_asset_others                                   |         11 |
| ruralsurvey_code_quantity_unit                                  |         11 |
| ruralsurvey_nrega_job_cards                                     |         10 |
| ruralsurvey_code_asset_furniture                                |         10 |
| ruralsurvey_team_members                                        |          9 |
| ruralsurvey_code_asset_transport                                |          8 |
| ruralsurvey_work_done_by_household_members_under_nrega          |          8 |
| ruralsurvey_costs                                               |          8 |
| ruralsurvey_coderentunit                                        |          8 |
| ruralsurvey_codesampletype                                      |          7 |
| ruralsurvey_code_commodity                                      |          7 |
| ruralsurvey_code_cooking_energy_source                          |          7 |
| ruralsurvey_codereligion                                        |          7 |
| ruralsurvey_experience_of_food_insecurity                       |          6 |
| ruralsurvey_codeirrigationsource                                |          6 |
| ruralsurvey_code_asset                                          |          6 |
| ruralsurvey_animal_resources_work_done_by_household_members     |          6 |
| ruralsurvey_code_reasons_for_sale                               |          6 |
| ruralsurvey_code_others_irrigation_other_nature_ex              |          5 |
| ruralsurvey_codeinputcategory                                   |          5 |
| ruralsurvey_code_reason_no_treatment                            |          5 |
| ruralsurvey_agricultural_labouring_out                          |          5 |
| ruralsurvey_consumption_of_frequent_food_week                   |          4 |
| ruralsurvey_codetenurialstatus                                  |          4 |
| ruralsurvey_codecropcommodity                                   |          4 |
| ruralsurvey_annual_consumption_of_major_items_of_food           |          4 |
| ruralsurvey_codevillage                                         |          4 |
| ruralsurvey_code_description_of_buyer_lessee                    |          4 |
| ruralsurvey_code_card_type                                      |          4 |
| ruralsurvey_animal_resources_for_last_one_year_inventory        |          4 |
| ruralsurvey_land_leased_out_share_rent                          |          4 |
| ruralsurvey_animal_resources_feed                               |          3 |
| ruralsurvey_code_payer                                          |          3 |
| ruralsurvey_codeanimaltype                                      |          3 |
| ruralsurvey_codeseasons                                         |          3 |
| auth_user_groups                                                |          3 |
| ruralsurvey_codeownershiptype                                   |          2 |
| auth_group                                                      |          2 |
| ruralsurvey_code_informal_saving_institions                     |          2 |
| ruralsurvey_codepowersource                                     |          2 |
| ruralsurvey_comments_and_investigators                          |          2 |
| ruralsurvey_input_use_for_crops                                 |          2 |
| ruralsurvey_bank_post_office_accounts                           |          1 |
| ruralsurvey_incidence_of_inpatient_treatment                    |          1 |
| ruralsurvey_code_credit_institutions                            |          1 |
| ruralsurvey_ration_cards                                        |          1 |
| ruralsurvey_other_costs_incurred_last_year                      |          1 |
| ruralsurvey_for_long_term_agricultural_workers                  |          1 |
| ruralsurvey_agricultural_non_agricultura_labour_services        |          1 |
| ruralsurvey_codemodeoftransport                                 |          1 |
| ruralsurvey_outstanding_loans                                   |          1 |
| ruralsurvey_input_use_for_crops_crop_number                     |          1 |
| ruralsurvey_impact_of_specified_events_on_access_to_livelihoods |          1 |
| ruralsurvey_ration_question                                     |          1 |
| ruralsurvey_expenditure_on_education                            |          1 |
| ruralsurvey_means_of_prod                                       |          0 |
| ruralsurvey_wells_ownership                                     |          0 |
| ruralsurvey_animal_resources_for_last_one_year_sale_disposal    |          0 |
| ruralsurvey_access_to_food_in_school_or_anganwadi               |          0 |
| ruralsurvey_codecontractduration                                |          0 |
| ruralsurvey_membership_in_self_help_groups                      |          0 |
| ruralsurvey_code_source_of_lighting                             |          0 |
| ruralsurvey_animal_resources_sale_production                    |          0 |
| ruralsurvey_use_of_informal_institutions_for_savings            |          0 |
| ruralsurvey_access_to_education_questions                       |          0 |
| ruralsurvey_freedom_of_employment                               |          0 |
| ruralsurvey_payments_made_to_managers_and_long_term_workers_gen |          0 |
| ruralsurvey_animal_resources_other_costs                        |          0 |
| ruralsurvey_payments_made_to_managers_and_long_term_workers     |          0 |
| ruralsurvey_land_mortgaged_in                                   |          0 |
| ruralsurvey_incidence_of_diseases_over_last_one_month           |          0 |
| ruralsurvey_labour_days_employed_and_wage_rates_agri            |          0 |
| ruralsurvey_child_help                                          |          0 |
| ruralsurvey_medical_insurance                                   |          0 |
| ruralsurvey_code_food                                           |          0 |
| ruralsurvey_land_mortgaged_out                                  |          0 |
| ruralsurvey_acquisition_and_loss_of_major_assets                |          0 |
| ruralsurvey_agricultural_loans_borrowed_last_year_and_repaid    |          0 |
| ruralsurvey_access_to_education_children                        |          0 |
| ruralsurvey_income_from_hiring_out_machinery                    |          0 |

* Emerging patterns

This section will provide a compilation of tables and graphs on different aspects of social and economic conditions in the village.

** Caste Composition

#+NAME: caste-composition-code
#+BEGIN_SRC R :results value :exports results :colnames yes :hline yes
  merge(household,villages,by.x="village_id",by.y="id")->t
    merge(t,castes,by.x="caste_tribe_id",by.y="id")->t
  t[,.(Number=length(household_number)),keyby=.(village_name,if_sc_st,caste_tribe)][CJ(unique(village_name),unique(if_sc_st),unique(caste_tribe))][,as.list(Number),by=.(if_sc_st,caste_tribe)]->t1
    t1[!(is.na(V1)&is.na(V3)&is.na(V3)&is.na(V4))]->t1
    names(t1)[c(3:6)]<-unique(t$village_name)
    names(t1)[c(1:2)]<-c("Social group","Caste")
    t1
#+END_SRC

#+NAME: caste-composition-code
#+CAPTION: Caste representation in the sample
#+RESULTS: caste-composition-code
| Social group | Caste          | Birdhana | Jamalpur Shekhan | Khandrai | Cheher Kalan |
|--------------+----------------+----------+------------------+----------+--------------|
| BC           | Bhatra sikh    |      nil | nil              | 1        | nil          |
| BC           | Jhimar/Dhinwar |        1 | nil              | nil      | 3            |
| BC           | Jogi           |      nil | nil              | nil      | 1            |
| BC           | Kamboj         |        5 | nil              | 3        | nil          |
| BC           | Khati          |      nil | 9                | 1        | 2            |
| BC           | Kumhar         |        1 | 2                | nil      | 5            |
| BC           | Lodhi          |        1 | nil              | nil      | nil          |
| BC           | Lohar          |        2 | 1                | 1        | nil          |
| BC           | Mali           |        1 | nil              | nil      | nil          |
| BC           | Nai            |        2 | 5                | 3        | nil          |
| BC           | Rebari         |       10 | nil              | nil      | nil          |
| BC           | Saini          |      nil | nil              | 14       | nil          |
| BC           | Teli           |        1 | nil              | nil      | nil          |
| BC           | Yadav          |      nil | nil              | nil      | 1            |
| Other        | Arora          |        3 | nil              | 3        | nil          |
| Other        | Baniya         |        1 | 3                | nil      | nil          |
| Other        | Bishnoi        |       11 | nil              | nil      | nil          |
| Other        | Brahmin        |      nil | 6                | nil      | 1            |
| Other        | Garg           |      nil | nil              | 1        | nil          |
| Other        | Jat            |       12 | 10               | 9        | 23           |
| Other        | Khati          |      nil | nil              | 3        | nil          |
| Other        | Mehta          |        6 | nil              | nil      | nil          |
| Other        | Sunar          |        1 | 1                | nil      | nil          |
| SC           | Balmiki        |      nil | nil              | 7        | 1            |
| SC           | Bawaria        |      nil | nil              | 1        | 1            |
| SC           | Bazigar        |        2 | nil              | 7        | nil          |
| SC           | Chamar         |       13 | 7                | 8        | 17           |
| SC           | Dhanak         |        8 | 9                | nil      | 17           |
| SC           | Mazhabi Sikh   |        1 | nil              | nil      | nil          |
| SC           | Meena          |        1 | nil              | nil      | nil          |
| SC           | Nayak          |        2 | nil              | nil      | nil          |
| SC           | Od             |        3 | nil              | 16       | nil          |
| SC           | Rai Sikh       |       15 | nil              | nil      | nil          |

** Occupations

#+NAME: occupation-preliminary-code
#+BEGIN_SRC R :results value :exports results :colnames yes :hline yes

  data.table(dbReadTable(surveypg,"ruralsurvey_codeoccupationcategory"))->codeoccupation
  codeoccupation[order(id)]->codeoccupation
  factor(codeoccupation$id)->codeoccupation$id2
  levels(codeoccupation$id2)<-codeoccupation$occupation_category
  codeoccupation[,.(id,occupation_category=id2)]->codeoccupation
  data.table(dbReadTable(surveypg,"ruralsurvey_occupations_household_members"))->occupations
  merge(occupations,codeoccupation,by.x="occupation_category_id",by.y="id")->occupations
  household[,c(1,2,3,12,24,25,26)]->t
  merge(occupations,t,by.x="sno_id",by.y="id")->occupations
  merge(occupations,castes,by.x="caste_tribe_id",by.y="id")->occupations
  merge(occupations,villages,by.x="village_id",by.y="id")->occupations
  member[,c(1,3,4,5,16)]->t
  merge(occupations,t,by.x=c("sno_id","name_id"),by.y=c("sno_id","id"))->occupations
  occupations[,.(numberofworkers=length(id)),keyby=.(village_name,occupation_category,sex)]->t
  t[CJ(unique(village_name),unique(occupation_category),unique(sex))][,as.list(numberofworkers),by=.(village_name,occupation_category)][!is.na(V1)&!is.na(V2)]->t
  names(t)[c(3:4)]<-levels(factor(occupations$sex))
  t
#+END_SRC

#+NAME: occupation
#+CAPTION: Number of sample workers by occupation
#+RESULTS: occupation-preliminary-code
| village_name     | occupation_category                        |   F |  M |
|------------------+--------------------------------------------+-----+----|
| Birdhana         | Peasant                                    |  29 | 73 |
| Birdhana         | Tenant peasant                             |   2 |  1 |
| Birdhana         | Tending animals                            |  97 | 56 |
| Birdhana         | Agricultural labour                        |  30 | 21 |
| Birdhana         | Tailor                                     |   7 |  2 |
| Birdhana         | NREGA workers/Labour in other public works |  11 |  5 |
| Birdhana         | Casual non-agricultural labour (other)     |   2 | 20 |
| Birdhana         | Teachers                                   |   2 |  1 |
| Birdhana         | Salaried government employee (other)       |   2 |  7 |
| Birdhana         | Salaried private office worker             |   1 |  3 |
| Birdhana         | Salaried private worker (other)            |   1 | 14 |
| Birdhana         | Student                                    |  84 | 86 |
| Birdhana         | Housework                                  | 153 |  3 |
| Birdhana         | Unable to work because of medical reasons  |   2 |  4 |
| Birdhana         | Sweetmeat seller/Halwai                    |   1 |  4 |
| Birdhana         | Longterm agricultural worker - Siri        |   1 |  7 |
| Birdhana         | Welfare pension beneficiary                |  16 | 19 |
| Birdhana         | Apprentice                                 |   1 |  5 |
| Cheher Kalan     | Peasant                                    |  23 | 46 |
| Cheher Kalan     | Tending animals                            |  45 | 16 |
| Cheher Kalan     | Agricultural labour                        |  18 | 28 |
| Cheher Kalan     | Mason                                      |   1 |  3 |
| Cheher Kalan     | NREGA workers/Labour in other public works |   4 |  4 |
| Cheher Kalan     | Casual non-agricultural labour (other)     |   1 |  5 |
| Cheher Kalan     | Teachers                                   |   2 |  1 |
| Cheher Kalan     | Salaried government employee (other)       |   3 |  5 |
| Cheher Kalan     | Shopkeeper                                 |   2 |  8 |
| Cheher Kalan     | Student                                    |  39 | 50 |
| Cheher Kalan     | Housework                                  |  54 |  5 |
| Cheher Kalan     | Too old to work                            |   4 |  3 |
| Cheher Kalan     | Unable to work because of medical reasons  |   1 |  1 |
| Cheher Kalan     | Driver                                     |   1 |  2 |
| Cheher Kalan     | Retired pensioner                          |   1 |  3 |
| Cheher Kalan     | Welfare pension beneficiary                |  15 | 13 |
| Gijji            | Peasant                                    |   3 | 14 |
| Gijji            | Tending animals                            |  20 | 13 |
| Gijji            | Agricultural labour                        |  20 | 20 |
| Gijji            | Construction labour                        |   1 |  6 |
| Gijji            | NREGA workers/Labour in other public works |   9 |  8 |
| Gijji            | Salaried private worker (other)            |   1 | 18 |
| Gijji            | Factory/business owner                     |   1 |  3 |
| Gijji            | Student                                    |  23 | 30 |
| Gijji            | Housework                                  |  63 |  6 |
| Gijji            | Unable to work because of medical reasons  |   1 |  2 |
| Gijji            | Welfare pension beneficiary                |   7 |  5 |
| Jamalpur Shekhan | Peasant                                    |  17 | 36 |
| Jamalpur Shekhan | Tending animals                            |  53 | 32 |
| Jamalpur Shekhan | Agricultural labour                        |  36 | 31 |
| Jamalpur Shekhan | Barber                                     |   1 |  3 |
| Jamalpur Shekhan | Tailor                                     |   7 |  2 |
| Jamalpur Shekhan | Construction labour                        |   1 | 23 |
| Jamalpur Shekhan | Domestic work                              |   4 |  2 |
| Jamalpur Shekhan | NREGA workers/Labour in other public works |  17 |  9 |
| Jamalpur Shekhan | Salaried government employee (other)       |   2 |  2 |
| Jamalpur Shekhan | Shopkeeper                                 |   8 | 14 |
| Jamalpur Shekhan | Student                                    |  47 | 65 |
| Jamalpur Shekhan | Housework                                  |  90 |  3 |
| Jamalpur Shekhan | Too old to work                            |   2 |  1 |
| Jamalpur Shekhan | Unable to work because of medical reasons  |   1 |  3 |
| Jamalpur Shekhan | Other                                      |   1 |  5 |
| Jamalpur Shekhan | Retired pensioner                          |   1 |  1 |
| Jamalpur Shekhan | Welfare pension beneficiary                |  23 | 15 |
| Khandrai         | Peasant                                    |  16 | 40 |
| Khandrai         | Tending animals                            |  48 | 26 |
| Khandrai         | Agricultural labour                        |  22 | 24 |
| Khandrai         | Construction labour                        |   1 |  8 |
| Khandrai         | Domestic work                              |   2 |  1 |
| Khandrai         | NREGA workers/Labour in other public works |   1 |  1 |
| Khandrai         | Casual non-agricultural labour (other)     |   4 | 26 |
| Khandrai         | Teachers                                   |   3 |  2 |
| Khandrai         | Salaried government employee (other)       |   5 |  5 |
| Khandrai         | Salaried private worker (other)            |   1 | 12 |
| Khandrai         | Shopkeeper                                 |   3 |  6 |
| Khandrai         | Factory/business owner                     |   3 | 13 |
| Khandrai         | Student                                    |  53 | 66 |
| Khandrai         | Housework                                  | 113 |  2 |
| Khandrai         | Too old to work                            |   3 |  6 |
| Khandrai         | Unable to work because of medical reasons  |   2 |  6 |

** Land relations
** Food security
** Cropping pattern, Production, Input use
** Labour Deployment
** Employment
** Livestock
** Housing and Sanitation
** Health and Education
** Assets and Indebtedness

#+INCLUDE: assets.org

* Kill Connections                                                 :noexport:

#+NAME: kill-ssh-connections
#+BEGIN_SRC R :results silent :exports none
  dbDisconnect(surveypg)
  GrepResults<-system2("ps",c("ax | grep 'ssh -L 3333'| grep 'singdehri'"),stdout=TRUE)
  Processes<-as.numeric(sub(" .*","",GrepResults)) 
  tools::pskill(Processes)
#+END_SRC

* 
